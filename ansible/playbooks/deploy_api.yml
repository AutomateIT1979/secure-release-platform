# TAG: INFRASTRUCTURE-CONFIG-P2-AZ
# PURPOSE: Deploy FastAPI application to EC2
# SCOPE: Production deployment
# SAFETY: Idempotent - updates running containers

# Deploy FastAPI Application Playbook
#
# Tasks:
#   1. Clone or update application code
#   2. Pull Docker image
#   3. Stop existing container (if any)
#   4. Run new container with docker-compose
#   5. Verify health endpoint
#
# Requirements:
#   - Docker installed on target
#   - Git configured
#   - Network access to Docker registry
#
# Usage:
#   ansible-playbook -i inventories/staging/hosts.yml playbooks/deploy_api.yml
#
# Verification:
#   curl http://35.180.54.218:8000/health
---
- name: Deploy Secure Release Platform API to EC2
  hosts: staging
  become: true
  vars:
    app_dir: /opt/secure-release-platform
  
  tasks:
    - name: Create application directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Copy application files with rsync
      shell: |
        rsync -avz \
          --exclude=.git \
          --exclude=.venv \
          --exclude=__pycache__ \
          --exclude=*.pyc \
          --exclude=.pytest_cache \
          --exclude=test.db \
          --exclude=docs \
          --exclude=ansible \
          --exclude=tests \
          -e "ssh -i ~/.ssh/lab-devops-key.pem -o StrictHostKeyChecking=no" \
          {{ playbook_dir }}/../../ ubuntu@{{ ansible_host }}:{{ app_dir }}/
      delegate_to: localhost
      become: false

    - name: Set proper ownership
      file:
        path: "{{ app_dir }}"
        owner: ubuntu
        group: ubuntu
        recurse: yes

    - name: Stop existing containers (if any)
      shell: docker compose down
      args:
        chdir: "{{ app_dir }}"
      become_user: ubuntu
      ignore_errors: true

    - name: Start application with Docker Compose
      shell: docker compose up --build -d
      args:
        chdir: "{{ app_dir }}"
      become_user: ubuntu

    - name: Wait for API to be ready
      wait_for:
        port: 8000
        delay: 5
        timeout: 60

    - name: Test API health endpoint
      uri:
        url: http://localhost:8000/health
        return_content: yes
      register: health_check

    - name: Display health check result
      debug:
        msg: "API health check: {{ health_check.json }}"
